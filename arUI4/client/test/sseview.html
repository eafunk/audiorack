<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>SSE Viewer</title>
		<script src="vumeter.js"></script>
		<script>
			window.onload = init;
			
			function init(){
				let vuel = document.getElementById("vu"); 
				for(let i = 0; i < 8; i++){
					let canv = document.createElement("canvas");
					canv.setAttribute('id', 'ch'+i);
					canv.setAttribute('width',10);
					canv.setAttribute('height',128);
					vumeter(canv, {
						"boxCount": 32,
						"boxCountRed": 9,
						"boxCountYellow": 7,
						"boxGapFraction": 0.25,
						"max": 255,
					});
					vuel.appendChild(canv);
				}
			}
			
			const es = new EventSource('/ssestream');
			const listener = function (event) {
				let idx = event.type.indexOf("vu_");
				if(idx == 0){
					let name = event.type.substring(idx);
					let vu = buffToUvObj(toArrayBuffer(event.data));
					let el = document.getElementById("vu"); 
					if(vu[0]){
						for(let c = 0; c < vu[0].pk.length; c++){
							let id = "ch"+c;
							canv = document.getElementById('ch'+c);
							canv.setAttribute('data-avr', vu[0].avr[c]);
							canv.setAttribute('data-pk', vu[0].pk[c]);
						}
					}
				}else{
					let el = document.getElementById("msg"); 
					el.innerHTML = event.type + ": "+event.data + "<br>";
				}
			};
			
			es.addEventListener('msg', listener);
			addListenersForAllSubscriptions();
			
			function addListenersForAllSubscriptions(){
				fetch("/sseget").then(response => {
					if(response.status == 201){
						// sucess...
						response.json().then(data => {
							data.forEach(entry => {
								es.addEventListener(entry, listener);
							});
						});
					}
				});
			}
			
			function toArrayBuffer(hexStr){
				let buffer = new ArrayBuffer(Math.ceil(hexStr.length / 2));
				let view = new Uint8Array(buffer);
				for(let i = 0; i < view.byteLength; i++)
					view[i] = parseInt(hexStr.substr(i*2, 2), 16);
				return buffer;
			}
			
			function buffToUvObj(buffer){
				// vu object -> id: {pk: [], avr: []}
				let result = {};
				let dataView = new DataView(buffer);
				let offset = 1;
				recCnt = dataView.getUint8(0);
				for(let i = 0; i < recCnt; i++){
					let uid = dataView.getUint32(offset);
					offset += 4;
					let ccnt = dataView.getUint8(offset);
					offset++;
					let pk = [];
					let avr = [];
					for(let c = 0; c < ccnt; c++){
						pk.push(dataView.getUint8(offset));
						offset++;
						avr.push(dataView.getUint8(offset));
						offset++
					}
					result[uid] = {pk: pk, avr: avr};
				}
				return result;
			}
			
			function eventChangeFunction(isRemove){
				if(isRemove){
					fetch("/sserem/"+document.getElementById("eventName").value).then(response => {
						if (response.status == 200){
							// sucess...
							es.removeEventListener(document.getElementById("eventName").value, listener);
						}
					});
				}else{
					fetch("/sseadd/"+document.getElementById("eventName").value).then(response => {
						if(response.status == 200){
							// sucess...
							addListenersForAllSubscriptions();
						}
					});
				}
			}
		</script>
	</head>
	<body>
		<div id='msg'></div>
		<div id='form'>
				<input id="eventName" type="text"/>
				<button onclick="eventChangeFunction(0);">add</button>
				<button onclick="eventChangeFunction(1);">remove</button>
		</div>
		<div id='vu'>
			
		</div>
	</body>
</html>
